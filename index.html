<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor V27.8 - Recorr√™ncia</title>
    
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2563eb; --green: #10b981; --red: #ef4444; --orange: #f97316; --purple: #8b5cf6; --bg: #f1f5f9; --card: #ffffff; --text: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; user-select: none; -webkit-tap-highlight-color: transparent; }
        .container { background: var(--card); width: 100%; max-width: 600px; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; }
        
        /* Bot√µes de Topo */
        .top-btns { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .config-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .config-btn:hover { opacity: 1; transform: scale(1.1); }

        .result-card { color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; transition: background 0.3s; }
        .bg-safe { background-color: var(--green); } .bg-warning { background-color: var(--orange); } .bg-danger { background-color: var(--red); }
        .dash-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .dash-tab-btn { background: rgba(255,255,255,0.2); border: none; padding: 5px 15px; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem; font-weight: bold; transition: 0.2s; }
        .dash-tab-btn.active { background: white; color: var(--primary); }
        .dash-view { display: none; animation: fadeIn 0.3s; } .dash-view.active { display: block; }
        .chart-wrapper { width: 100%; min-height: 280px; height: auto; background-color: #f8fafc; border-radius: 8px; padding: 15px; box-sizing: border-box; color: #333; position: relative; display: flex; flex-direction: column; }
        .chart-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; flex-shrink: 0; }
        .chart-toggle { background: #e2e8f0; border: none; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; color: #64748b; font-weight: bold; }
        .chart-toggle.active { background: var(--primary); color: white; }
        .pie-filters { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
        .pie-filter-btn { background: white; border: 1px solid #cbd5e1; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; cursor: pointer; color: #64748b; font-weight: bold; }
        .pie-filter-btn.active { background: #64748b; color: white; border-color: #64748b; }
        .big-val { font-size: 2.2rem; font-weight: 800; display: block; margin-top: 5px; }
        .sub-row { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); }
        .limit-container { margin-bottom: 20px; background: #fff7ed; padding: 15px; border-radius: 12px; border: 1px solid #ffedd5; }
        .limit-header { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; color: var(--orange); margin-bottom: 8px; }
        .limit-bg { background: #fed7aa; height: 10px; border-radius: 5px; overflow: hidden; }
        .limit-fill { height: 100%; background: var(--orange); width: 0%; transition: width 0.5s ease; }
        .tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: 600; color: #64748b; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .view-section { display: none; } .view-section.active { display: block; }
        .header-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .nav-btn { background: white; border: 1px solid #cbd5e1; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; color: var(--primary); font-weight: bold; }
        #navMonth { border: 1px solid transparent; background: transparent; font-size: 1.2rem; font-weight: 800; color: var(--text); font-family: inherit; cursor: pointer; text-align: center; padding: 5px 10px; border-radius: 8px; transition: all 0.2s; }
        #navMonth:hover { background: #e2e8f0; }
        .box { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 20px; background: white; border-left: 5px solid #ccc; }
        .box-green { border-left-color: var(--green); } .box-red { border-left-color: var(--red); } .box-orange { border-left-color: var(--orange); }
        .box-head { display: flex; justify-content: space-between; align-items: center; font-weight: 700; margin-bottom: 12px; }
        .head-actions { display: flex; align-items: center; gap: 10px; }
        .btn-copy { background: none; border: 1px solid rgba(0,0,0,0.1); border-radius: 4px; cursor: pointer; padding: 2px 6px; font-size: 1rem; transition: 0.2s; }
        .btn-copy:hover { background: rgba(0,0,0,0.05); transform: scale(1.1); }
        .input-row { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; outline: none; font-family: inherit; font-size: 0.9rem; }
        input[type=number] { -moz-appearance: textfield; } 
        .input-date { width: 130px; font-size: 0.85rem; color: #64748b; }
        .input-cat { width: 110px; padding: 5px; font-size: 0.85rem; cursor: pointer; text-overflow: ellipsis; }
        .btn-add { border: none; width: 45px; border-radius: 6px; color: white; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .list { list-style: none; padding: 0; margin: 0; }
        .item { padding: 10px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; }
        .item-main { display: flex; justify-content: space-between; align-items: center; }
        .day-badge { background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; font-weight: bold; min-width: 25px; text-align: center; display: inline-block; }
        .cat-icon { margin-right: 5px; font-size: 0.85rem; color: #64748b; font-weight: 600; }
        .item-special { background-color: #f0fdf4; padding: 8px; border-radius: 6px; margin-bottom: 5px; border: 1px dashed var(--green); font-weight: bold; font-size: 0.85rem; color: #166534; display: flex; justify-content: space-between; }
        .item-special-debt { background-color: #fff7ed; padding: 8px; border-radius: 6px; margin-bottom: 5px; border: 1px dashed var(--orange); font-weight: bold; font-size: 0.85rem; color: #9a3412; display: flex; justify-content: space-between; }
        .del { cursor: pointer; color: #cbd5e1; margin-left: 10px; } .del:hover { color: var(--red); }
        details { margin-top: 5px; font-size: 0.85rem; color: #334155; background: #e0f2fe; padding: 10px; border-radius: 6px; border: 1px solid #bae6fd; }
        summary { cursor: pointer; list-style: none; font-weight: bold; color: var(--primary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .sug-list { max-height: 150px; overflow-y: auto; }
        .sug-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #cbd5e1; font-size: 0.85rem; }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .day { background: white; border: 1px solid #cbd5e1; padding: 8px 0; border-radius: 6px; font-size: 0.85rem; cursor: pointer; text-align: center; }
        .day.active { background: var(--primary); color: white; } .day.today { border: 2px dashed var(--primary); }
        
        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-opt { margin-bottom: 15px; }
        .modal-opt label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #64748b; }
        .btn-confirm { background: var(--green); color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; width: 100%; cursor: pointer; }
        .btn-cancel { background: #e2e8f0; color: #64748b; border: none; padding: 10px; border-radius: 6px; font-weight: bold; width: 100%; cursor: pointer; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        
        /* PDF Styles */
        .report-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .report-title { margin: 0; color: var(--primary); font-size: 1.4rem; }
        .report-subtitle { color: #64748b; font-size: 0.9rem; margin-top: 5px; }
        .rep-filters { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .rep-btn { padding: 6px 12px; border: 1px solid #cbd5e1; background: white; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #64748b; }
        .rep-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .report-list { list-style: none; padding: 0; margin: 0; }
        .report-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; page-break-inside: avoid; }
        .report-row:last-child { border-bottom: none; }
        .rep-in-txt { color: #166534; }
        .rep-out-txt { color: #991b1b; }
        .rep-day { font-weight: bold; margin-right: 10px; min-width: 25px; color: #64748b; }
        .rep-desc { flex: 1; display: flex; flex-direction: column; }
        .rep-cat { font-size: 0.75rem; opacity: 0.7; }
        .rep-val { font-weight: bold; }
        .rep-footer { margin-top: 15px; border-top: 2px solid #e2e8f0; padding-top: 15px; background: #f8fafc; border-radius: 8px; padding: 15px; page-break-inside: avoid; }
        .rep-summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .rep-total-final { font-size: 1.1rem; font-weight: 800; color: #334155; margin-top: 10px; border-top: 1px dashed #cbd5e1; padding-top: 10px; }
        .pdf-btn { width: 100%; background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .pdf-btn:hover { background: #1e293b; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="top-btns">
            <button class="config-btn" onclick="openFixedModal()" title="Despesas Fixas">üìÖ</button>
            <button class="config-btn" onclick="openSetupModal()" title="Configura√ß√µes">‚öôÔ∏è</button>
        </div>

        <div class="limit-container">
            <div class="limit-header"><span id="labelLimitTitle">Limite Global</span><span id="txtCreditLimit">...</span></div>
            <div class="limit-bg"><div id="barCredit" class="limit-fill"></div></div>
        </div>

        <div id="painelRes" class="result-card bg-safe">
            <div class="dash-tabs">
                <button class="dash-tab-btn active" onclick="switchDash('nums')">üí∞ Valores</button>
                <button class="dash-tab-btn" onclick="switchDash('graph')">üìà Gr√°fico</button>
            </div>
            <div id="dash-nums" class="dash-view active">
                <div style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; margin-bottom: 10px;">
                    <span style="font-size:0.8rem; text-transform:uppercase;">Saldo Dispon√≠vel</span>
                    <span class="big-val" id="valSaldoLiq">R$ 0,00</span>
                </div>
                <div class="sub-row">
                    <div style="text-align:left"><span style="font-size:0.8rem">Di√°rio</span><br><strong id="valDiario" style="font-size:1.1rem">R$ 0,00</strong></div>
                    <div style="text-align:center"><span style="font-size:0.8rem">Semanal</span><br><strong id="valSemanal" style="font-size:1.1rem">R$ 0,00</strong></div>
                    <div style="text-align:right"><span id="labelStatus" style="font-weight:bold; font-size:0.8rem">...</span><br><span id="infoDias" style="font-size:0.75rem; opacity:0.8">...</span></div>
                </div>
            </div>
            <div id="dash-graph" class="dash-view">
                <div class="chart-wrapper">
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="setChartType('bar')">Fluxo</button>
                        <button class="chart-toggle" onclick="setChartType('pie')">Categorias</button>
                    </div>
                    <div id="pieFilterOpts" class="pie-filters" style="display:none;">
                        <button class="pie-filter-btn active" onclick="setPieFilter('all')">Tudo</button>
                        <button class="pie-filter-btn" onclick="setPieFilter('debit')">D√©bito</button>
                        <button class="pie-filter-btn" onclick="setPieFilter('credit')">Cr√©dito</button>
                    </div>
                    <canvas id="balanceChart" style="max-height: 230px;"></canvas>
                </div>
            </div>
        </div>

        <div class="tabs"><button class="tab-btn active" onclick="switchTab('budget')">üìä Lan√ßamentos</button><button class="tab-btn" onclick="switchTab('wishes')">‚ú® Desejos</button></div>

        <div id="viewBudget" class="view-section active">
            <div class="header-nav">
                <button class="nav-btn" onclick="mudarMes(-1)">‚Äπ</button>
                <input type="month" id="navMonth" onchange="pickMonth(this.value)">
                <button class="nav-btn" onclick="mudarMes(1)">‚Ä∫</button>
                <button class="nav-btn" style="width:auto; padding:0 10px; font-size:1.2rem; margin-left:5px" onclick="openReport()" title="Extrato">üìÑ</button>
            </div>
            <div id="gridCal" class="grid"></div>
            <div class="box box-green">
                <div class="box-head" style="color:var(--green)"><span>Entradas</span><div class="head-actions"><button class="btn-copy" onclick="copyPrev('in')" title="Copiar m√™s anterior">üîÑ</button><span id="totIn">R$ 0,00</span></div></div>
                <ul id="listIn" class="list"></ul>
                <div class="input-row" style="margin-top:10px">
                    <input type="date" id="inDate" class="input-date">
                    <select id="catIn" class="input-cat"><option value="üí∞ Sal√°rio">üí∞ Sal√°rio</option><option value="üíµ Pagamentos">üíµ Pagamentos</option><option value="üè∑Ô∏è Vendas">üè∑Ô∏è Vendas</option></select>
                    <input id="inNome" placeholder="Ex: Adiantamento" style="flex:2; min-width: 80px;">
                    <input type="number" id="inVal" placeholder="0.00" step="0.01" style="flex:1; min-width: 60px;">
                    <button class="btn-add" style="background:var(--green)" onclick="add('in')">+</button>
                </div>
            </div>
            <div class="box box-red">
                <div class="box-head" style="color:var(--red)"><span>Sa√≠das D√©bito</span><div class="head-actions"><button class="btn-copy" onclick="copyPrev('debit')" title="Copiar m√™s anterior">üîÑ</button><span id="totDebit">R$ 0,00</span></div></div>
                <ul id="listDebit" class="list"></ul>
                <div class="input-row">
                    <input type="date" id="debDate" class="input-date">
                    <select id="catDeb" class="input-cat"><option value="üè† Casa">üè† Casa</option><option value="üçî Alimenta√ß√£o">üçî Alimenta√ß√£o</option><option value="üöó Transporte">üöó Transporte</option><option value="üë§ Pessoal">üë§ Pessoal</option><option value="üéüÔ∏è Ingressos">üéüÔ∏è Ingressos</option><option value="üçª Bebidas">üçª Bebidas</option><option value="üéâ Divers√£o">üéâ Divers√£o</option></select>
                    <input id="debNome" placeholder="Ex: Almo√ßo" style="flex:2; min-width: 80px;">
                    <input type="number" id="debVal" placeholder="0.00" step="0.01" style="flex:1; min-width: 60px;">
                    <button class="btn-add" style="background:var(--red)" onclick="add('debit')">+</button>
                </div>
            </div>
            <div class="box box-orange">
                <div class="box-head" style="color:var(--orange)"><span>Cart√£o de Cr√©dito</span><div class="head-actions"><button class="btn-copy" onclick="copyPrev('credit')" title="Copiar m√™s anterior">üîÑ</button><span id="totCredit">R$ 0,00</span></div></div>
                <ul id="listCredit" class="list"></ul>
                <div class="input-row" style="margin-top:10px">
                    <input type="date" id="credDate" class="input-date">
                    <select id="catCred" class="input-cat"><option value="üè† Casa">üè† Casa</option><option value="üçî Alimenta√ß√£o">üçî Alimenta√ß√£o</option><option value="üöó Transporte">üöó Transporte</option><option value="üë§ Pessoal">üë§ Pessoal</option><option value="üéüÔ∏è Ingressos">üéüÔ∏è Ingressos</option><option value="üçª Bebidas">üçª Bebidas</option><option value="üéâ Divers√£o">üéâ Divers√£o</option></select>
                    <input id="credNome" placeholder="Ex: Uber" style="flex:2; min-width: 80px;">
                    <input type="number" id="credVal" placeholder="0.00" step="0.01" style="flex:1; min-width: 60px;">
                    <button class="btn-add" style="background:var(--orange)" onclick="add('credit')">+</button>
                </div>
            </div>
            <div class="box" style="border-left-color:#334155; background:#f8fafc;">
                <div class="box-head"><span>Pagamento de Fatura (M√™s Atual)</span></div>
                <div class="input-row"><input type="number" id="invPaid" placeholder="Valor pago..." step="0.01" style="flex:2"><button class="btn-add" style="background:#334155; width:auto; padding:0 15px; font-size:0.9rem" onclick="payInvoice()">Pagar</button></div>
            </div>
        </div>

        <div id="viewWishes" class="view-section">
            <div class="box" style="border-left-color:var(--purple)">
                <div class="box-head" style="color:var(--purple)"><span>Desejos & Planejamento</span></div>
                <div class="input-row"><input id="wishNome" placeholder="Item..." style="flex:2"><input type="number" id="wishVal" placeholder="0.00" step="0.01" style="flex:1"><button class="btn-add" style="background:var(--purple)" onclick="add('wishes')">+</button></div>
                <ul id="listWish" class="list"></ul>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal-overlay"><div class="modal"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px"><button onclick="document.getElementById('reportModal').style.display='none'" style="background:none; border:none; font-size:1rem; cursor:pointer; color:#64748b">‚úï Fechar</button></div><div id="printableArea" style="padding:10px; background:white; width:100%;"><div class="report-header"><h3 class="report-title" id="repTitle">Extrato Mensal</h3><div class="report-subtitle" id="repSubtitle">...</div></div><div class="rep-filters" data-html2canvas-ignore="true"><button class="rep-btn active" onclick="updateReport('all')">Tudo</button><button class="rep-btn" onclick="updateReport('in')">Entradas</button><button class="rep-btn" onclick="updateReport('out')">Sa√≠das</button></div><div id="reportContent"></div></div><button class="pdf-btn" onclick="exportPDF()">üìÑ Baixar PDF</button></div></div>
    
    <div id="setupModal" class="modal-overlay"><div class="modal"><h3>Configura√ß√µes</h3><div class="modal-opt"><label>Limite Cart√£o</label><input type="number" id="setupLimit"></div><div class="modal-opt"><label>Meta Di√°ria</label><input type="number" id="setupGoal"></div><button class="btn-confirm" onclick="saveSetup()">Salvar</button></div></div>
    
    <div id="buyModal" class="modal-overlay"><div class="modal"><h3>Comprar Item</h3><p id="modalItemName" style="color:var(--primary); font-weight:bold; margin-bottom:15px">...</p><div class="modal-opt"><label>Pagamento:</label><select id="modalType" onchange="toggleInstallments()"><option value="debit">D√©bito (√Ä vista)</option><option value="credit">Cr√©dito (Cart√£o)</option></select></div><div class="modal-opt"><label>Categoria:</label><select id="modalCat" style="width:100%; padding:10px;"><option value="üè† Casa">üè† Casa</option><option value="üçî Alimenta√ß√£o">üçî Alimenta√ß√£o</option><option value="üöó Transporte">üöó Transporte</option><option value="üë§ Pessoal">üë§ Pessoal</option><option value="üéüÔ∏è Ingressos">üéüÔ∏è Ingressos</option><option value="üçª Bebidas">üçª Bebidas</option><option value="üéâ Divers√£o">üéâ Divers√£o</option></select></div><div id="creditOptions" style="display:none;"><div class="modal-opt"><label>Parcelas:</label><input type="number" id="modalInstallments" value="1" min="1"></div><div class="modal-opt"><label>In√≠cio:</label><input type="month" id="modalStartMonth"></div></div><div class="modal-btns"><button class="btn-cancel" onclick="closeBuyModal()">Cancelar</button><button class="btn-confirm" onclick="confirmBuy()">Confirmar Compra</button></div></div></div>

    <div id="fixedModal" class="modal-overlay">
        <div class="modal">
            <h3>Despesas Fixas (Recorrentes)</h3>
            <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px">Itens adicionados aqui podem ser lan√ßados automaticamente todo m√™s.</p>
            
            <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div class="input-row">
                    <input id="fixName" placeholder="Ex: Aluguel" style="flex:2">
                    <input type="number" id="fixVal" placeholder="Valor" style="flex:1; min-width:60px">
                </div>
                <div class="input-row">
                    <input type="number" id="fixDay" placeholder="Dia" min="1" max="31" style="width:60px">
                    <select id="fixType" style="flex:1">
                        <option value="debit">D√©bito (Conta)</option>
                        <option value="credit">Cr√©dito (Cart√£o)</option>
                    </select>
                    <select id="fixCat" style="flex:1">
                        <option value="üè† Casa">üè† Casa</option>
                        <option value="üçî Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                        <option value="üöó Transporte">üöó Transporte</option>
                        <option value="üë§ Pessoal">üë§ Pessoal</option>
                    </select>
                </div>
                <button class="btn-confirm" onclick="addFixed()">Adicionar √† Lista</button>
            </div>

            <ul id="listFixed" class="list" style="max-height:200px; overflow-y:auto; margin-bottom:15px"></ul>
            
            <button class="btn-cancel" onclick="document.getElementById('fixedModal').style.display='none'">Fechar</button>
        </div>
    </div>

    <script>
        let dataNav = new Date(); const hoje = new Date(); let diaSel = hoje.getDate();
        let settings = { limit: 4000, dailyGoal: 30 };
        // ATUALIZA√á√ÉO DB: Agora tem 'fixed'
        let dbGlobal = { wishes: [], fixed: [] }; 
        let dbMensal = {};
        let myChart = null; let selectedWishIndex = null;
        let chartType = 'bar';
        let currentReportFilter = 'all';
        let pieFilter = 'all'; 

        window.onload = () => {
            const s = localStorage.getItem('appV25_settings'); if(s) settings = JSON.parse(s);
            const g = localStorage.getItem('appV25_g'); 
            if(g) {
                dbGlobal = JSON.parse(g);
                if(!dbGlobal.fixed) dbGlobal.fixed = []; // Garante compatibilidade com vers√µes antigas
            }
            
            const y = dataNav.getFullYear(); const m = String(dataNav.getMonth() + 1).padStart(2, '0');
            document.getElementById('modalStartMonth').value = `${y}-${m}`;
            
            render();
            checkFixedExpenses(); // VERIFICA RECORR√äNCIA AO INICIAR

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.log);
            }
        };

        // --- FUN√á√ïES DE RECORR√äNCIA ---
        function openFixedModal() {
            renderFixedList();
            document.getElementById('fixedModal').style.display = 'flex';
        }

        function addFixed() {
            const n = document.getElementById('fixName').value;
            const v = parseFloat(document.getElementById('fixVal').value);
            const d = parseInt(document.getElementById('fixDay').value) || 1;
            const t = document.getElementById('fixType').value;
            const c = document.getElementById('fixCat').value;

            if(n && v > 0) {
                dbGlobal.fixed.push({n, v, d, t, c});
                localStorage.setItem('appV25_g', JSON.stringify(dbGlobal));
                
                document.getElementById('fixName').value = '';
                document.getElementById('fixVal').value = '';
                renderFixedList();
            } else { alert('Preencha nome e valor.'); }
        }

        function delFixed(i) {
            dbGlobal.fixed.splice(i, 1);
            localStorage.setItem('appV25_g', JSON.stringify(dbGlobal));
            renderFixedList();
        }

        function renderFixedList() {
            const ul = document.getElementById('listFixed');
            ul.innerHTML = "";
            if(dbGlobal.fixed.length === 0) {
                ul.innerHTML = "<li style='text-align:center; color:#999; padding:10px'>Nenhuma despesa fixa cadastrada.</li>";
                return;
            }
            dbGlobal.fixed.forEach((it, i) => {
                const typeIcon = it.t === 'debit' ? 'üî¥' : 'üü†';
                ul.innerHTML += `
                <li class="item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem">${typeIcon} ${it.n}</div>
                        <div style="font-size:0.75rem; color:#64748b">Dia ${it.d} ‚Ä¢ ${it.c}</div>
                    </div>
                    <div style="text-align:right">
                        <strong>${fmt(it.v)}</strong>
                        <span class="del" onclick="delFixed(${i})">‚úï</span>
                    </div>
                </li>`;
            });
        }

        function checkFixedExpenses() {
            // Verifica se estamos no m√™s atual (real) ou navegando
            // L√≥gica: S√≥ sugere lan√ßar se abrir o app no m√™s corrente e ainda n√£o tiver lan√ßado
            const k = getKey(hoje.getFullYear(), hoje.getMonth());
            
            // Pega o DB do m√™s ATUAL (n√£o do navegado)
            let dbAtual = localStorage.getItem(k) ? JSON.parse(localStorage.getItem(k)) : null;
            
            // Se n√£o existir DB para este m√™s, cria um b√°sico para poder checar
            if (!dbAtual) dbAtual = { in:[], debit:[], credit:[], invoicePaid:0, fixedLaunched: false };

            // Se tem itens fixos cadastrados E ainda n√£o foram lan√ßados neste m√™s
            if (dbGlobal.fixed.length > 0 && !dbAtual.fixedLaunched) {
                if(confirm(`üìÖ Novo M√™s Detectado!\n\nExistem ${dbGlobal.fixed.length} despesas fixas cadastradas (Total: ${fmt(dbGlobal.fixed.reduce((a,b)=>a+b.v,0))}).\n\nDeseja lan√ßar elas no extrato de agora?`)) {
                    
                    dbGlobal.fixed.forEach(it => {
                        if(it.t === 'debit') {
                            dbAtual.debit.push({ n: it.n + ' (Fixo)', v: it.v, d: it.d, c: it.c });
                        } else {
                            dbAtual.credit.push({ n: it.n + ' (Fixo)', v: it.v, d: it.d, c: it.c });
                        }
                    });
                    
                    dbAtual.fixedLaunched = true;
                    localStorage.setItem(k, JSON.stringify(dbAtual));
                    
                    // Se estivermos vendo o m√™s atual, atualiza a tela
                    if(dataNav.getMonth() === hoje.getMonth() && dataNav.getFullYear() === hoje.getFullYear()) {
                        render();
                    }
                    alert("Despesas lan√ßadas com sucesso!");
                } else {
                    // Se o usu√°rio negar, marcamos como lan√ßado para n√£o perguntar de novo? 
                    // Melhor n√£o, ele pode querer lan√ßar depois. Mas para n√£o ficar chato, vamos ignorar por enquanto.
                    // Se quiser "cancelar para sempre neste m√™s", descomente a linha abaixo:
                    // dbAtual.fixedLaunched = true; localStorage.setItem(k, JSON.stringify(dbAtual));
                }
            }
        }

        // --- FUN√á√ïES PADR√ÉO (Mesmas da vers√£o anterior) ---
        function getKey(a,m) { return `appV25_m_${a}_${m}`; }
        function getDB(a, m) {
            const k = getKey(a, m);
            if(!dbMensal[k]) {
                const saved = localStorage.getItem(k);
                dbMensal[k] = saved ? JSON.parse(saved) : { in:[], debit:[], credit:[], invoicePaid:0 };
            }
            return dbMensal[k];
        }

        function setChartType(type) {
            chartType = type;
            document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
            const pieFilterEl = document.getElementById('pieFilterOpts');
            if(type === 'pie') pieFilterEl.style.display = 'flex'; else pieFilterEl.style.display = 'none';
            renderChart(dataNav.getFullYear(), dataNav.getMonth());
        }
        function setPieFilter(filter) {
            pieFilter = filter;
            document.querySelectorAll('.pie-filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderChart(dataNav.getFullYear(), dataNav.getMonth());
        }
        function renderChart(curAno, curMes) {
            const ctx = document.getElementById('balanceChart');
            if(myChart) myChart.destroy();

            if (chartType === 'bar') {
                let labels = []; let dataSaldo = []; let dataFatura = [];
                for(let i=0; i<6; i++) {
                    let d = new Date(curAno, curMes + i, 1);
                    let lAno = d.getFullYear(); let lMes = d.getMonth();
                    let rep = calcularRepasses(lAno, lMes);
                    let k = getKey(lAno, lMes);
                    let db = localStorage.getItem(k) ? JSON.parse(localStorage.getItem(k)) : { in:[], debit:[], credit:[] };
                    let mIn = db.in.reduce((a,b)=>a+b.v,0) + rep.sobra;
                    let mDeb = db.debit.reduce((a,b)=>a+b.v,0);
                    let mFat = db.credit.reduce((a,b)=>a+b.v,0) + rep.divida;
                    labels.push(d.toLocaleString('pt-BR', {month:'short'}));
                    dataSaldo.push(mIn - mDeb - mFat);
                    dataFatura.push(mFat);
                }
                myChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Saldo Disp.', data: dataSaldo, backgroundColor: dataSaldo.map(v => v < 0 ? '#ef4444' : '#10b981'), order: 2, borderRadius: 4 }, { label: 'Fatura', data: dataFatura, type: 'line', borderColor: '#334155', backgroundColor: '#334155', borderWidth: 2, tension: 0.3, pointRadius: 4, order: 1 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });
            } else {
                const db = getDB(curAno, curMes);
                const categories = {};
                const rep = calcularRepasses(curAno, curMes);

                if(pieFilter === 'all' || pieFilter === 'debit') {
                    db.debit.forEach(i => { const c = i.c || 'üë§ Pessoal'; categories[c] = (categories[c] || 0) + i.v; });
                }
                if(pieFilter === 'all' || pieFilter === 'credit') {
                    db.credit.forEach(i => { const c = i.c || 'üë§ Pessoal'; categories[c] = (categories[c] || 0) + i.v; });
                    if(rep.divida > 0) { const c = '‚ö†Ô∏è Pend√™ncia Fatura'; categories[c] = (categories[c] || 0) + rep.divida; }
                }

                const labels = Object.keys(categories);
                const data = Object.values(categories);
                const colors = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#34d399', '#22d3ee', '#818cf8', '#e879f9'];

                myChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 11 }, padding: 10 } } } } });
            }
        }
        function calcularRepasses(anoAlvo, mesAlvo) {
            let dividaTransportada = 0; let sobraTransportada = 0;
            const keys = Object.keys(localStorage).filter(k => k.startsWith('appV25_m_')).sort();
            keys.forEach(key => {
                const [,, kAno, kMes] = key.split('_').map(Number);
                if (kAno < anoAlvo || (kAno === anoAlvo && kMes < mesAlvo)) {
                    const mData = JSON.parse(localStorage.getItem(key));
                    const mCred = mData.credit.reduce((acc, x) => acc + x.v, 0);
                    const mPaid = mData.invoicePaid || 0;
                    if (mPaid > 0) {
                        const faturaReal = mCred + dividaTransportada;
                        const balanco = mPaid - faturaReal;
                        if (balanco >= 0) { sobraTransportada = balanco; dividaTransportada = 0; } 
                        else { dividaTransportada = Math.abs(balanco); sobraTransportada = 0; }
                    } else { dividaTransportada = 0; sobraTransportada = 0; }
                }
            });
            return { sobra: sobraTransportada, divida: dividaTransportada };
        }
        
        function render() {
            const a = dataNav.getFullYear(); const m = dataNav.getMonth();
            const d = getDB(a, m);
            const yStr = a; const mStr = String(m + 1).padStart(2, '0');
            document.getElementById('navMonth').value = `${yStr}-${mStr}`;
            const lastDay = new Date(a, m + 1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            const firstDateStr = `${yStr}-${mStr}-01`;
            const lastDateStr = `${yStr}-${mStr}-${lastDay}`;
            ['inDate', 'debDate', 'credDate'].forEach(id => { 
                const el = document.getElementById(id); el.min = firstDateStr; el.max = lastDateStr;
                if(a === hoje.getFullYear() && m === hoje.getMonth()) el.value = todayStr; else el.value = firstDateStr;
            });
            const repasse = calcularRepasses(a, m);
            const sIn = d.in.reduce((acc, x) => acc + x.v, 0);
            const sDeb = d.debit.reduce((acc, x) => acc + x.v, 0);
            const sCred = d.credit.reduce((acc, x) => acc + x.v, 0);
            const ulIn = document.getElementById('listIn'); ulIn.innerHTML = "";
            if (repasse.sobra > 0) ulIn.innerHTML += `<li class="item item-special"><div>üí∞ Sobra Fatura Anterior</div><strong>${fmt(repasse.sobra)}</strong></li>`;
            d.in.forEach((it, i) => addLi(ulIn, it, i, 'in'));
            const ulCred = document.getElementById('listCredit'); ulCred.innerHTML = "";
            if (repasse.divida > 0) ulCred.innerHTML += `<li class="item item-special-debt"><div>‚ö†Ô∏è Pend√™ncia Fatura Anterior</div><strong>${fmt(repasse.divida)}</strong></li>`;
            d.credit.forEach((it, i) => addLi(ulCred, it, i, 'credit'));
            list('listDebit', d.debit, 'debit'); listW(); 
            const totalEntradas = sIn + repasse.sobra;
            const totalFatura = sCred + repasse.divida;
            const disponivel = totalEntradas - sDeb - totalFatura;
            document.getElementById('totIn').innerText = fmt(totalEntradas);
            document.getElementById('totDebit').innerText = fmt(sDeb);
            document.getElementById('totCredit').innerText = fmt(totalFatura);
            document.getElementById('valSaldoLiq').innerText = fmt(disponivel);
            document.getElementById('invPaid').value = d.invoicePaid || "";
            const ultDia = new Date(a, m+1, 0).getDate();
            const diasRest = Math.max(1, (ultDia - diaSel) + 1);
            const diario = disponivel / diasRest;
            document.getElementById('valDiario').innerText = fmt(diario);
            document.getElementById('valSemanal').innerText = fmt(diario * 7); 
            document.getElementById('infoDias').innerText = `${diasRest} dias restantes`;
            const painel = document.getElementById('painelRes');
            painel.className = "result-card"; 
            if (disponivel <= 0) { painel.classList.add("bg-danger"); document.getElementById('labelStatus').innerText = "‚ö†Ô∏è Negativo"; }
            else if (diario < 30) { painel.classList.add("bg-warning"); document.getElementById('labelStatus').innerText = "‚ö†Ô∏è Aten√ß√£o (<30)"; }
            else { painel.classList.add("bg-safe"); document.getElementById('labelStatus').innerText = "‚úÖ Confort√°vel"; }
            updateCalendar(a, m, ultDia); updateGlobalLimit(); renderChart(a, m);
        }
        function add(tipo) {
            const d = getDB(dataNav.getFullYear(), dataNav.getMonth());
            let nameId='', valId='', dateId='', catId='', targetArr=null;
            if(tipo === 'in') { nameId='inNome'; valId='inVal'; dateId='inDate'; catId='catIn'; targetArr=d.in; }
            else if(tipo === 'debit') { nameId='debNome'; valId='debVal'; dateId='debDate'; catId='catDeb'; targetArr=d.debit; }
            else if(tipo === 'credit') { nameId='credNome'; valId='credVal'; dateId='credDate'; catId='catCred'; targetArr=d.credit; }
            else if(tipo === 'wishes') { nameId='wishNome'; valId='wishVal'; targetArr=dbGlobal.wishes; }
            const elName = document.getElementById(nameId); const elVal = document.getElementById(valId);
            if(elName && elVal) {
                const name = elName.value; const val = parseFloat(elVal.value);
                if(name && !isNaN(val) && val > 0) {
                    if(tipo === 'wishes') { targetArr.push({ n: name, v: val }); localStorage.setItem('appV25_g', JSON.stringify(dbGlobal)); } 
                    else { const elDate = document.getElementById(dateId); const elCat = document.getElementById(catId); const day = elDate ? parseInt(elDate.value.split('-')[2]) : 1; const cat = elCat ? elCat.value : 'üë§ Pessoal'; targetArr.push({ n: name, v: val, d: day, c: cat }); save(); }
                    elName.value = ''; elVal.value = ''; render();
                } else { alert("Preencha corretamente."); }
            }
        }
        function del(tipo, i) { if(tipo==='wishes'){ dbGlobal.wishes.splice(i,1); localStorage.setItem('appV25_g', JSON.stringify(dbGlobal)); } else { getDB(dataNav.getFullYear(), dataNav.getMonth())[tipo].splice(i,1); save(); } render(); }
        function openBuyModal(index) { selectedWishIndex = index; const item = dbGlobal.wishes[index]; document.getElementById('modalItemName').innerText = `${item.n} - ${fmt(item.v)}`; document.getElementById('buyModal').style.display = 'flex'; toggleInstallments(); }
        function closeBuyModal() { document.getElementById('buyModal').style.display = 'none'; selectedWishIndex = null; }
        function toggleInstallments() { document.getElementById('creditOptions').style.display = document.getElementById('modalType').value === 'credit' ? 'block' : 'none'; }
        function confirmBuy() {
            if(selectedWishIndex === null) return;
            const item = dbGlobal.wishes[selectedWishIndex]; const type = document.getElementById('modalType').value; const cat = document.getElementById('modalCat').value;
            if (type === 'debit') { const db = getDB(dataNav.getFullYear(), dataNav.getMonth()); const isCurrentMonth = (dataNav.getMonth() === hoje.getMonth() && dataNav.getFullYear() === hoje.getFullYear()); const dayToUse = isCurrentMonth ? hoje.getDate() : 1; db.debit.push({n: item.n, v: item.v, d: dayToUse, c: cat}); save(); } 
            else { const parcelas = parseInt(document.getElementById('modalInstallments').value) || 1; const startStr = document.getElementById('modalStartMonth').value; if(!startStr) return alert("Escolha o m√™s"); let [sY, sM] = startStr.split('-').map(Number); sM -= 1; const vParc = item.v / parcelas; for (let i = 0; i < parcelas; i++) { let curM = sM + i; let curY = sY; while (curM > 11) { curM -= 12; curY++; } let dbFuturo = getKey(curY, curM); let dadosFuturo = localStorage.getItem(dbFuturo) ? JSON.parse(localStorage.getItem(dbFuturo)) : { in:[], debit:[], credit:[], invoicePaid:0 }; dadosFuturo.credit.push({ n: `${item.n} (${i+1}/${parcelas})`, v: vParc, d: 1, c: cat }); localStorage.setItem(dbFuturo, JSON.stringify(dadosFuturo)); } }
            dbGlobal.wishes.splice(selectedWishIndex, 1); localStorage.setItem('appV25_g', JSON.stringify(dbGlobal)); closeBuyModal(); switchTab('budget'); render();
        }
        function switchDash(mode) { document.querySelectorAll('.dash-tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.dash-view').forEach(v => v.classList.remove('active')); if(mode === 'nums') { document.getElementById('dash-nums').classList.add('active'); document.querySelectorAll('.dash-tab-btn')[0].classList.add('active'); } else { document.getElementById('dash-graph').classList.add('active'); document.querySelectorAll('.dash-tab-btn')[1].classList.add('active'); } }
        function updateGlobalLimit() { let total = 0; let pago = 0; Object.keys(localStorage).filter(k=>k.startsWith('appV25_m_')).forEach(k=>{ let d = JSON.parse(localStorage.getItem(k)); total += d.credit.reduce((a,b)=>a+b.v,0); pago += (d.invoicePaid||0); }); let used = Math.max(0, total - pago); let pct = Math.min(100, (used/settings.limit)*100); document.getElementById('txtCreditLimit').innerText = `Usado: ${fmt(used)}`; document.getElementById('barCredit').style.width = pct + "%"; }
        function updateCalendar(a, m, ultDia) { const grid = document.getElementById('gridCal'); grid.innerHTML = ""; for(let i=1; i<=ultDia; i++){ const div = document.createElement('div'); div.className = `day ${i===diaSel?'active':''} ${(a===hoje.getFullYear()&&m===hoje.getMonth()&&i===hoje.getDate())?'today':''}`; div.innerText = i; div.onclick = () => { diaSel=i; render(); }; grid.appendChild(div); } }
        function addLi(ul, it, i, tipo) { const catIcon = it.c || 'üë§ Pessoal'; ul.innerHTML += `<li class="item"><div class="item-main"><div><span class="day-badge">${it.d||1}</span><span class="cat-icon">${catIcon}</span><span>${it.n}</span></div><div><strong>${fmt(it.v)}</strong><span class="del" onclick="del('${tipo}',${i})">‚úï</span></div></div></li>`; }
        function list(id, arr, tipo) { const ul = document.getElementById(id); ul.innerHTML = ""; arr.forEach((it, i) => addLi(ul, it, i, tipo)); }
        function listW() { const ul = document.getElementById('listWish'); ul.innerHTML = ""; dbGlobal.wishes.forEach((it, i) => { ul.innerHTML += `<li class="item" style="display:block"><div class="item-main"><span>${it.n}</span><div><strong>${fmt(it.v)}</strong><button style="margin-left:5px; background:var(--purple); color:white; border:none; border-radius:4px; cursor:pointer" onclick="openBuyModal(${i})">Comprar</button><span class="del" onclick="del('wishes',${i})">‚úï</span></div></div><details><summary>üí° Dica IA (1x a 12x)</summary>${generateAdvice(it.v)}</details></li>`; }); }
        function payInvoice() { const val = parseFloat(document.getElementById('invPaid').value); if (isNaN(val)) { alert("Digite um valor v√°lido."); return; } const db = getDB(dataNav.getFullYear(), dataNav.getMonth()); db.invoicePaid = val; save(); alert("Pagamento registrado!"); }
        function save() { localStorage.setItem(getKey(dataNav.getFullYear(), dataNav.getMonth()), JSON.stringify(getDB(dataNav.getFullYear(), dataNav.getMonth()))); render(); }
        function mudarMes(v) { dataNav.setMonth(dataNav.getMonth() + v); diaSel = 1; render(); }
        function fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function switchTab(t) { document.getElementById('viewBudget').classList.toggle('active', t==='budget'); document.getElementById('viewWishes').classList.toggle('active', t==='wishes'); document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', (i===0 && t==='budget') || (i===1 && t==='wishes'))); }
        function openSetupModal() { document.getElementById('setupModal').style.display='flex'; document.getElementById('setupLimit').value=settings.limit; document.getElementById('setupGoal').value=settings.dailyGoal; }
        function saveSetup() { settings.limit = parseFloat(document.getElementById('setupLimit').value) || 4000; settings.dailyGoal = parseFloat(document.getElementById('setupGoal').value) || 30; localStorage.setItem('appV25_settings', JSON.stringify(settings)); document.getElementById('setupModal').style.display='none'; render(); }
        function getSimulatedBalance(year, month) {
            const k = getKey(year, month);
            if(localStorage.getItem(k)) {
                const db = JSON.parse(localStorage.getItem(k));
                const rep = calcularRepasses(year, month);
                const sIn = db.in.reduce((a,b)=>a+b.v,0) + rep.sobra;
                const sDeb = db.debit.reduce((a,b)=>a+b.v,0);
                const sCred = db.credit.reduce((a,b)=>a+b.v,0) + rep.divida;
                return sIn - sDeb - sCred;
            } else {
                const curDB = getDB(dataNav.getFullYear(), dataNav.getMonth());
                const sIn = curDB.in.reduce((a,b)=>a+b.v,0); 
                const sDeb = curDB.debit.reduce((a,b)=>a+b.v,0); 
                return sIn - sDeb; 
            }
        }
        function generateAdvice(totalVal) {
            let html = "<div class='sug-list'>";
            const meta = settings.dailyGoal;
            let foundOption = false;
            for(let p = 1; p <= 12; p++) {
                let parcVal = totalVal / p;
                let bestStartMonth = null;
                for(let offset = 0; offset <= 5; offset++) {
                    let targetDate = new Date(dataNav.getFullYear(), dataNav.getMonth() + offset, 1);
                    let saldoPrevisto = getSimulatedBalance(targetDate.getFullYear(), targetDate.getMonth());
                    if ( (saldoPrevisto - parcVal) >= (meta * 20) ) { bestStartMonth = targetDate.toLocaleString('pt-BR', { month: 'long' }); break; }
                }
                if(bestStartMonth) {
                    html += `<div class="sug-item"><span>${p}x de ${fmt(parcVal)}</span><span>In√≠cio: <strong style="text-transform:capitalize">${bestStartMonth}</strong></span></div>`;
                    foundOption = true;
                }
            }
            if(!foundOption) html += `<div class="sug-item" style="color:var(--red)">Nenhuma op√ß√£o segura encontrada.</div>`;
            return html + "</div>";
        }
        function exportPDF() {
            const element = document.getElementById('printableArea'); const clone = element.cloneNode(true);
            const container = document.createElement('div'); container.style.position = 'absolute'; container.style.left = '-9999px'; container.style.top = '0'; container.style.width = '794px'; container.style.zIndex = '-1';
            clone.style.width = '100%'; clone.style.height = 'auto'; clone.style.minHeight = '100%'; clone.style.maxHeight = 'none'; clone.style.overflow = 'visible';
            const filters = clone.querySelector('.rep-filters'); if(filters) filters.remove();
            container.appendChild(clone); document.body.appendChild(container);
            const totalHeight = clone.scrollHeight + 50; const monthName = dataNav.toLocaleString('pt-BR', {month:'long', year:'numeric'});
            const opt = { margin: [10, 10, 10, 10], filename: `Extrato_${monthName}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, scrollY: 0, useCORS: true, windowWidth: 800, windowHeight: totalHeight, height: totalHeight }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
            html2pdf().set(opt).from(clone).save().then(() => { document.body.removeChild(container); }).catch(err => { console.error("Erro ao gerar PDF:", err); document.body.removeChild(container); });
        }
        function openReport() { currentReportFilter = 'all'; updateReportUI(); document.getElementById('reportModal').style.display = 'flex'; }
        function updateReport(filter) { currentReportFilter = filter; document.querySelectorAll('.rep-btn').forEach(b => b.classList.remove('active')); const btns = document.querySelectorAll('.rep-btn'); if(filter === 'all') btns[0].classList.add('active'); else if(filter === 'in') btns[1].classList.add('active'); else btns[2].classList.add('active'); updateReportUI(); }
        function updateReportUI() { const d = getDB(dataNav.getFullYear(), dataNav.getMonth()); const monthName = dataNav.toLocaleString('pt-BR', {month:'long', year:'numeric'}); document.getElementById('repSubtitle').innerText = monthName.charAt(0).toUpperCase() + monthName.slice(1); let timeline = []; const rep = calcularRepasses(dataNav.getFullYear(), dataNav.getMonth()); if(rep.sobra > 0) timeline.push({ n: 'üí∞ Sobra Fatura Anterior', v: rep.sobra, type: 'in', d: 1, c: 'Autom√°tico' }); if(rep.divida > 0) timeline.push({ n: '‚ö†Ô∏è Pend√™ncia Fatura Anterior', v: rep.divida, type: 'out', d: 1, c: 'Autom√°tico' }); d.in.forEach(i => timeline.push({...i, type: 'in'})); d.debit.forEach(i => timeline.push({...i, type: 'out'})); d.credit.forEach(i => timeline.push({...i, type: 'cred'})); if (currentReportFilter === 'in') timeline = timeline.filter(i => i.type === 'in'); if (currentReportFilter === 'out') timeline = timeline.filter(i => i.type === 'out' || i.type === 'cred'); timeline.sort((a, b) => (a.d || 1) - (b.d || 1)); let sumIn = 0, sumOut = 0; timeline.forEach(i => { if(i.type === 'in') sumIn += i.v; else sumOut += i.v; }); let html = `<ul class="report-list">`; if(timeline.length === 0) html += `<li style="text-align:center; color:#999; padding:20px">Nenhum registro.</li>`; timeline.forEach(item => { let cls = item.type === 'in' ? 'rep-in' : (item.type === 'out' ? 'rep-out' : 'rep-cred'); let colorClass = item.type === 'in' ? 'rep-in-txt' : 'rep-out-txt'; let signal = item.type === 'in' ? '+' : '-'; html += `<li class="report-row ${cls}" style="background-color: ${item.type==='in'?'#dcfce7':(item.type==='out'?'#fee2e2':'#ffedd5')};"><div style="display:flex; align-items:center"><span class="rep-day">${String(item.d||1).padStart(2, '0')}</span><div class="rep-desc"><span style="font-weight:600">${item.n}</span><span class="rep-cat">${item.c || 'Geral'} ${item.type==='cred' ? '(Cart√£o)' : ''}</span></div></div><span class="rep-val ${colorClass}">${signal} ${fmt(item.v)}</span></li>`; }); html += `</ul>`; const saldoFinal = sumIn - sumOut; const colorFinal = saldoFinal >= 0 ? 'var(--green)' : 'var(--red)'; html += `<div class="rep-footer"><div class="rep-summary-row"><span>Total Entradas:</span> <strong style="color:var(--green)">${fmt(sumIn)}</strong></div><div class="rep-summary-row"><span>Total Sa√≠das:</span> <strong style="color:var(--red)">${fmt(sumOut)}</strong></div><div class="rep-summary-row rep-total-final" style="display:flex; justify-content:space-between;"><span>Saldo do M√™s:</span><span style="color:${colorFinal}">${fmt(saldoFinal)}</span></div></div>`; document.getElementById('reportContent').innerHTML = html; }
        function copyPrev(type) { let prevD = new Date(dataNav.getFullYear(), dataNav.getMonth() - 1, 1); let prevKey = getKey(prevD.getFullYear(), prevD.getMonth()); if(!localStorage.getItem(prevKey)) { alert("N√£o h√° dados no m√™s anterior."); return; } let prevData = JSON.parse(localStorage.getItem(prevKey)); let itemsToCopy = prevData[type]; if(!itemsToCopy || itemsToCopy.length === 0) { alert("Nenhum item nesta categoria m√™s passado."); return; } if(!confirm(`Copiar ${itemsToCopy.length} itens do m√™s anterior?`)) return; const currentDB = getDB(dataNav.getFullYear(), dataNav.getMonth()); const maxDaysInMonth = new Date(dataNav.getFullYear(), dataNav.getMonth() + 1, 0).getDate(); itemsToCopy.forEach(it => { let validDay = it.d || 1; if (validDay > maxDaysInMonth) validDay = maxDaysInMonth; currentDB[type].push({ n: it.n, v: it.v, d: validDay, c: it.c || 'üí∏' }); }); save(); }
    </script>
</body>
</html>
